services:
  rabbitmq-service:
    image: rabbitmq:3.11-management
    healthcheck:
      test: rabbitmq-diagnostics check_port_connectivity
      interval: 10s # Khoảng thời gian giữa các lần thử lại.
      retries: 5 # Nếu không có response hoặc response không phải là UP thì sẽ thử lại 10 lần.
      timeout: 5s # Với mỗi lần thử, nếu sau 5s mà không có response thì sẽ coi là không thành công.
      start_period: 10s # Sau 10s kể từ khi start thì mới bắt đầu kiểm tra healthcheck
    deploy:
      resources:
        limits:
          memory: 256M
    restart: on-failure
    networks:
      - e-commerce
    ports:
      - "15672:15672"
      - "5672:5672"
      - "61613:61613"
    environment:
      - RABBITMQ_PLUGINS=rabbitmq_stomp
      - RABBITMQ_PLUGINS=rabbitmq_web_stomp
    command: >
      bash -c "rabbitmq-plugins enable rabbitmq_management && 
               rabbitmq-plugins enable rabbitmq_stomp && 
               rabbitmq-server"
  

  config-server:
    image: config-server:1.0
    restart: on-failure
    networks:
      - e-commerce
    healthcheck:
      test: "curl --fail --silent http://localhost:8071/actuator/health/readiness | grep UP || exit 1"  # Kiểm tra xem config-server có sẵn sàng không. Khi response của curl là UP thì coi như config-server đã sẵn sàng.
      interval: 10s # Khoảng thời gian giữa các lần thử lại.
      retries: 10 # Nếu không có response hoặc response không phải là UP thì sẽ thử lại 10 lần.
      timeout: 5s # Với mỗi lần thử, nếu sau 5s mà không có response thì sẽ coi là không thành công.
      start_period: 15s # Sau 15s kể từ khi start thì mới bắt đầu kiểm tra healthcheck
    ports:
      - "8071:8071"
    depends_on:
      rabbitmq-service:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 400M
    environment:
      - SPRING_RABBITMQ_HOST=rabbitmq-service
      - SPRING_RABBITMQ_PORT=5672
      - SPRING_RABBITMQ_USERNAME=guest
      - SPRING_RABBITMQ_PASSWORD=guest
      - SPRING_CLOUD_CONFIG_SERVER_GIT_PASSWORD=${SPRING_CLOUD_CONFIG_SERVER_GIT_PASSWORD}

  service-discovery:
    image: service-discovery:1.0
    restart: on-failure
    healthcheck:
      test: "curl --fail --silent http://localhost:8761/actuator/health/readiness | grep UP || exit 1"  # Kiểm tra xem config-server có sẵn sàng không. Khi response của curl là UP thì coi như config-server đã sẵn sàng.
      interval: 10s # Khoảng thời gian giữa các lần thử lại.
      retries: 10 # Nếu không có response hoặc response không phải là UP thì sẽ thử lại 10 lần.
      timeout: 5s # Với mỗi lần thử, nếu sau 5s mà không có response thì sẽ coi là không thành công.
      start_period: 15s # Sau 15s kể từ khi start thì mới bắt đầu kiểm tra healthcheck
    networks:
      - e-commerce
    environment:
      - SPRING_PROFILES_ACTIVE=default
      - SPRING_APPLICATION_NAME=service-discovery
      - SPRING_CONFIG_IMPORT=optional:configserver:http://config-server:8071/
      - SPRING_RABBITMQ_HOST=rabbitmq-service
      - SPRING_RABBITMQ_PORT=5672
      - SPRING_RABBITMQ_USERNAME=guest
      - SPRING_RABBITMQ_PASSWORD=guest
    ports:
      - "8761:8761"
    depends_on:
      config-server:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 400M

  redis-service:
    image: redis:7.4
    restart: unless-stopped
    networks:
      - e-commerce
    ports:
      - "6379:6379"
    deploy:
      resources:
        limits:
          memory: 400M
  api-gateway:
    image: api-gateway:1.0
    restart: on-failure
    networks:
      - e-commerce
    healthcheck:
      test: "curl --fail --silent http://localhost:8080/actuator/health/readiness | grep UP || exit 1"
      interval: 10s
      retries: 10
      timeout: 5s
      start_period: 15s
    deploy:
      resources:
        limits:
          memory: 400M
    ports:
      - "8080:8080"
    depends_on:
      service-discovery:
        condition: service_healthy
    env_file:
      - .env
    environment:
      - SPRING_PROFILES_ACTIVE=default
      - SPRING_APPLICATION_NAME=api-gateway
      - SPRING_CONFIG_IMPORT=optional:configserver:http://config-server:8071/
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://service-discovery:8761/eureka/
      - SPRING_DATA_REDIS_HOST=redis-service
      - SPRING_DATA_REDIS_PORT=6379
      - SPRING_RABBITMQ_HOST=rabbitmq-service
      - SPRING_RABBITMQ_PORT=5672
      - SPRING_RABBITMQ_USERNAME=guest
      - SPRING_RABBITMQ_PASSWORD=guest
      - GRPC_SERVER_AUTH_SERVICE_ADDRESS=static://auth-service:9093

  auth-db-service:
    image: mysql:8.0
    restart: on-failure
    networks:
      - e-commerce
    healthcheck:
      test: [ "CMD", "mysqladmin" ,"ping", "-h", "localhost" ]
      timeout: 10s
      retries: 5
      interval: 10s
      start_period: 15s
    env_file:
      - .env
    environment:
      - MYSQL_DATABASE=ecommerce_auth
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
    ports:
      - "3305:3306"
    volumes:
      - auth-db-data:/var/lib/mysql

  # =======================
  # Authentication Service
  # =======================
  auth-service:
    image: auth-service:1.0
    networks:
      - e-commerce
    deploy:
      resources:
        limits:
          memory: 512M
    restart: on-failure
    env_file:
      - .env
    ports:
      - "9093:9093"
      - "8083:8083"
    depends_on:
      config-server:
        condition: service_healthy
      service-discovery:
        condition: service_healthy
      api-gateway:
        condition: service_started
      auth-db-service:
        condition: service_healthy
    environment:
      - SPRING_APPLICATION_NAME=auth-service
      - SPRING_PROFILES_ACTIVE=default
      - SPRING_CONFIG_IMPORT=optional:configserver:http://config-server:8071/
      - SPRING_APPLICATION_SECURITY_JWT_ACCESS_TOKEN_KEY=${SPRING_APPLICATION_SECURITY_JWT_ACCESS_TOKEN_KEY}
      - SPRING_APPLICATION_SECURITY_JWT_REFRESH_TOKEN_KEY=${SPRING_APPLICATION_SECURITY_JWT_REFRESH_TOKEN_KEY}
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://service-discovery:8761/eureka/
      - BRAVO_API_KEY=${BRAVO_API_KEY}
      - SPRING_DATA_REDIS_HOST=redis-service
      - SPRING_DATA_REDIS_PORT=6379
      - SPRING_CACHE_TYPE=redis
      - SPRING_RABBITMQ_HOST=rabbitmq-service
      - SPRING_RABBITMQ_PORT=5672
      - SPRING_RABBITMQ_USERNAME=guest
      - SPRING_RABBITMQ_PASSWORD=guest
      - SPRING_SQL_INIT_MODE=never
      - SPRING_DATASOURCE_URL=jdbc:mysql://auth-db-service:3306/ecommerce_auth
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=${MYSQL_ROOT_PASSWORD}
      # APPLICATION_SERVER_PORT được dùng để gửi email tới cho người dùng mới tạo tài khoản. Xem trong chức năng register.


  cart-db-service:
    image: mysql:8.0
    restart: on-failure
    networks:
      - e-commerce
    healthcheck:
      test: [ "CMD", "mysqladmin" ,"ping", "-h", "localhost" ]
      timeout: 10s
      retries: 5
      interval: 10s
      start_period: 15s
    env_file:
      - .env
    environment:
      - MYSQL_DATABASE=ecommerce_cart
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
    ports:
      - "3307:3306"
    volumes:
      - cart-db-data:/var/lib/mysql

  # =======================
  # Cart Service
  # =======================
  cart-service:
    image: cart-service:1.0
    networks:
      - e-commerce
    deploy:
      resources:
        limits:
          memory: 512M
    restart: on-failure
    ports:
      - "8082:8082"
    env_file:
      - .env
    depends_on:
      config-server:
        condition: service_healthy
      service-discovery:
        condition: service_healthy
      cart-db-service:
        condition: service_healthy
    environment:
      - SPRING_PROFILES_ACTIVE=default
      - SPRING_APPLICATION_NAME=cart-service
      - SPRING_CONFIG_IMPORT=optional:configserver:http://config-server:8071/
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://service-discovery:8761/eureka/
      - EUREKA_INSTANCE_PREFERIPADDRESS=true
      - AWS_ACCESS_KEY=${AWS_ACCESS_KEY}
      - AWS_SECRET_KEY=${AWS_SECRET_KEY}
      - AWS_REGION=${AWS_REGION}
      - AWS_BUCKET_NAME=${AWS_BUCKET_NAME}
      - AWS_CLOUDFRONT_DOMAIN=${AWS_CLOUDFRONT_DOMAIN}
      - SPRING_RABBITMQ_HOST=rabbitmq-service
      - SPRING_RABBITMQ_PORT=5672
      - SPRING_RABBITMQ_USERNAME=guest
      - SPRING_RABBITMQ_PASSWORD=guest
      - SPRING_DATASOURCE_URL=jdbc:mysql://cart-db-service:3306/ecommerce_cart
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - GRPC_SERVER_PRODUCT_SERVICE_ADDRESS=static://product-service:9091



  order-db-service:
    image: mysql:8.0
    restart: on-failure
    networks:
      - e-commerce
    healthcheck:
      test: [ "CMD", "mysqladmin" ,"ping", "-h", "localhost" ]
      timeout: 10s
      retries: 5
      interval: 10s
      start_period: 15s
    env_file:
      - .env
    environment:
      - MYSQL_DATABASE=ecommerce_order
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
    ports:
      - "3308:3306"
    volumes:
      - order-db-data:/var/lib/mysql
  # =======================
  # Order Service
  # =======================
  order-service:
    image: order-service:1.0
    networks:
      - e-commerce
    deploy:
      resources:
        limits:
          memory: 768M
    restart: on-failure
    ports:
      - "9094:9094"
      - "8084:8084"
    env_file:
      - .env
    depends_on:
      config-server:
        condition: service_healthy
      service-discovery:
        condition: service_healthy
      order-db-service:
        condition: service_healthy
    environment:
      - SPRING_PROFILES_ACTIVE=default
      - SPRING_APPLICATION_NAME=booking-service
      - SPRING_CONFIG_IMPORT=optional:configserver:http://config-server:8071/
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://service-discovery:8761/eureka/
      - SPRING_RABBITMQ_HOST=rabbitmq-service
      - SPRING_RABBITMQ_PORT=5672
      - SPRING_RABBITMQ_USERNAME=guest
      - SPRING_RABBITMQ_PASSWORD=guest
      - SPRING_DATASOURCE_URL=jdbc:mysql://order-db-service:3306/ecommerce_order
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - GRPC_SERVER_USER_SERVICE_ADDRESS=static://user-service:9098
      - GRPC_SERVER_PRODUCT_SERVICE_ADDRESS=static://product-service:9091
      - AXON_AXONSERVER_SERVERS=localhost:8124

  payment-db-service:
    image: mysql:8.0
    restart: on-failure
    networks:
      - e-commerce
    healthcheck:
      test: [ "CMD", "mysqladmin" ,"ping", "-h", "localhost" ]
      timeout: 10s
      retries: 5
      interval: 10s
      start_period: 15s
    environment:
      - MYSQL_DATABASE=ecommerce_payment
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
    ports:
      - "3309:3306"
    volumes:
      - payment-db-data:/var/lib/mysql
  # =======================
  # Payment Service
  # =======================
  payment-service:
    deploy:
      resources:
        limits:
          memory: 512M
    image: payment-service:1.0
    restart: on-failure
    networks:
      - e-commerce
    depends_on:
      config-server:
        condition: service_healthy
      service-discovery:
        condition: service_healthy
      payment-db-service:
        condition: service_healthy
    env_file:
      - .env
    ports:
      - "8086:8086"
    environment:
      - SPRING_PROFILES_ACTIVE=default
      - SPRING_APPLICATION_NAME=payment-service
      - SPRING_CONFIG_IMPORT=optional:configserver:http://config-server:8071/
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://service-discovery:8761/eureka/
      - SPRING_RABBITMQ_HOST=rabbitmq-service
      - SPRING_RABBITMQ_PORT=5672
      - SPRING_RABBITMQ_USERNAME=guest
      - SPRING_RABBITMQ_PASSWORD=guest
      - SPRING_DATASOURCE_URL=jdbc:mysql://payment-db-service:3306/ecommerce_payment
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=${MYSQL_ROOT_PASSWORD}



  # =======================
  # Product Service
  # =======================
  product-db-service:
    image: mysql:8.0
    restart: on-failure
    networks:
      - e-commerce
    healthcheck:
      test: [ "CMD", "mysqladmin" ,"ping", "-h", "localhost" ]
      timeout: 10s
      retries: 5
      interval: 10s
      start_period: 15s
    environment:
      - MYSQL_DATABASE=ecommerce_product
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
    ports:
      - "3310:3306"
    volumes:
      - product-db-data:/var/lib/mysql

  product-service:
    deploy:
      resources:
        limits:
          memory: 768M
    image: product-service:1.0
    restart: on-failure
    networks:
      - e-commerce
    depends_on:
      config-server:
        condition: service_healthy
      service-discovery:
        condition: service_healthy
      product-db-service:
        condition: service_healthy
    env_file:
      - .env
    ports:
      - "8081:8081"
      - "9091:9091"
    environment:
      - SPRING_APPLICATION_NAME=product-service
      - SPRING_PROFILES_ACTIVE=default
      - SPRING_CONFIG_IMPORT=optional:configserver:http://config-server:8071/
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://service-discovery:8761/eureka/
      - SPRING_RABBITMQ_HOST=rabbitmq-service
      - SPRING_RABBITMQ_PORT=5672
      - SPRING_RABBITMQ_USERNAME=guest
      - SPRING_RABBITMQ_PASSWORD=guest
      - SPRING_DATASOURCE_URL=jdbc:mysql://product-db-service:3306/ecommerce_product
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - AXON_AXONSERVER_SERVERS=localhost:8124
      - CLOUDINARY_CLOUD_NAME=${CLOUDINARY_CLOUD_NAME}
      - CLOUDINARY_API_KEY=${CLOUDINARY_API_KEY}
      - CLOUDINARY_API_SECRET=${CLOUDINARY_API_SECRET}



  # =======================
  # Promotion Service
  # =======================
  promotion-db-service:
    image: mysql:8.0
    restart: on-failure
    networks:
      - e-commerce
    healthcheck:
      test: [ "CMD", "mysqladmin" ,"ping", "-h", "localhost" ]
      timeout: 10s
      retries: 5
      interval: 10s
      start_period: 15s
    environment:
      - MYSQL_DATABASE=ecommerce_promotion
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
    ports:
      - "3311:3306"
    volumes:
      - promotion-db-data:/var/lib/mysql

  promotion-service:
    deploy:
      resources:
        limits:
          memory: 512M
    image: promotion-service:1.0
    restart: on-failure
    networks:
      - e-commerce
    depends_on:
      config-server:
        condition: service_healthy
      service-discovery:
        condition: service_healthy
      promotion-db-service:
        condition: service_healthy
    env_file:
      - .env
    ports:
      - "8085:8085"
    environment:
      - SPRING_PROFILES_ACTIVE=default
      - SPRING_APPLICATION_NAME=promotion-service
      - SPRING_CONFIG_IMPORT=optional:configserver:http://config-server:8071/
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://service-discovery:8761/eureka/
      - SPRING_RABBITMQ_HOST=rabbitmq-service
      - SPRING_RABBITMQ_PORT=5672
      - SPRING_RABBITMQ_USERNAME=guest
      - SPRING_RABBITMQ_PASSWORD=guest
      - SPRING_DATASOURCE_URL=jdbc:mysql://promotion-db-service:3306/ecommerce_promotion
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - AXON_AXONSERVER_SERVERS=localhost:8124


  # =======================
  # User Service
  # =======================
  user-db-service:
    image: mysql:8.0
    restart: on-failure
    networks:
      - e-commerce
    healthcheck:
      test: [ "CMD", "mysqladmin" ,"ping", "-h", "localhost" ]
      timeout: 10s
      retries: 5
      interval: 10s
      start_period: 15s
    environment:
      - MYSQL_DATABASE=ecommerce_user
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
    ports:
      - "3312:3306"
    volumes:
      - user-db-data:/var/lib/mysql

  user-service:
    deploy:
      resources:
        limits:
          memory: 400M
    image: user-service:1.0
    restart: on-failure
    networks:
      - e-commerce
    depends_on:
      config-server:
        condition: service_healthy
      service-discovery:
        condition: service_healthy
      user-db-service:
        condition: service_healthy
    env_file:
      - .env
    ports:
      - "8088:8088"
      - "9098:9098"
    environment:
      - SPRING_APPLICATION_NAME=user-service
      - SPRING_PROFILES_ACTIVE=default
      - SPRING_CONFIG_IMPORT=optional:configserver:http://config-server:8071/
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://service-discovery:8761/eureka/
      - SPRING_RABBITMQ_HOST=rabbitmq-service
      - SPRING_RABBITMQ_PORT=5672
      - SPRING_RABBITMQ_USERNAME=guest
      - SPRING_RABBITMQ_PASSWORD=guest
      - SPRING_DATASOURCE_URL=jdbc:mysql://promotion-db-service:3306/ecommerce_promotion
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - AXON_AXONSERVER_SERVERS=localhost:8124



  # =======================
  # File Service
  # =======================
  file-service:
    deploy:
      resources:
        limits:
          memory: 400M
    image: file-service:1.0
    restart: on-failure
    networks:
      - e-commerce
    depends_on:
      config-server:
        condition: service_healthy
      service-discovery:
        condition: service_healthy
    env_file:
      - .env
    ports:
      - "8089:8089"
    environment:
      - SPRING_PROFILES_ACTIVE=default
      - SPRING_APPLICATION_NAME=file-service
      - SPRING_CONFIG_IMPORT=optional:configserver:http://config-server:8071/
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://service-discovery:8761/eureka/
      - SPRING_RABBITMQ_HOST=rabbitmq-service
      - SPRING_RABBITMQ_PORT=5672
      - SPRING_RABBITMQ_USERNAME=guest
      - SPRING_RABBITMQ_PASSWORD=guest
      - CLOUDINARY_CLOUD_NAME=${CLOUDINARY_CLOUD_NAME}
      - CLOUDINARY_API_KEY=${CLOUDINARY_API_KEY}
      - CLOUDINARY_API_SECRET=${CLOUDINARY_API_SECRET}
#
#
#  # =======================
#  # AXON SERVER
#  # =======================
#  axon-server:
#    image: axoniq/axonserver:4.7.0
#    restart: on-failure
#    networks:
#      - e-commerce
#    healthcheck:
#      test: "curl --fail --silent http://localhost:8024/actuator/health/readiness | grep UP || exit 1"  # Kiểm tra xem axon-server có sẵn sàng không. Khi response của curl là UP thì coi như axon-server đã sẵn sàng.
#      interval: 10s # Khoảng thời gian giữa các lần thử lại.
#      retries: 10 # Nếu không có response hoặc response không phải là UP thì sẽ thử lại 10 lần.
#      timeout: 5s # Với mỗi lần thử, nếu sau 5s mà không có response thì sẽ coi là không thành công.
#      start_period: 10s # Sau 10s kể từ khi start thì mới bắt đầu kiểm tra healthcheck
#    ports:
#      - "8124:8124"
#      - "8024:8024"
#    environment:
#      - 'AXONIQ_AXONSERVER_STANDALONE=TRUE'
#    volumes:
#      - axon-server-data:/data

networks:
  e-commerce:
    driver: "bridge"

# =======================
# Docker Volumes
# =======================
volumes:
  auth-db-data:
    driver: local
  order-db-data:
    driver: local
  payment-db-data:
    driver: local
  user-db-data:
    driver: local
  product-db-data:
    driver: local
  cart-db-data:
    driver: local
  axon-server-data:
    driver: local
  promotion-db-data:
    driver: local
  notification-db-data:
    driver: local
  review-db-data:
    driver: local